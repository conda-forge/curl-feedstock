{% set version = "7.86.0" %}

package:
  name: curl_split_recipe
  version: {{ version }}

source:
  url: http://curl.haxx.se/download/curl-{{ version }}.tar.bz2
  sha256: f5ca69db03eea17fa8705bdfb1a9f58d76a46c9010518109bb38f313137e0a28

build:
  number: 0

requirements:
  build:
    - libtool  # [unix]
    - {{ compiler('c') }}
    - make             # [unix]
    # perl is required to run the tests on UNIX.
    - perl  # [unix]
    - pkg-config  # [unix]
  host:
    - zlib
    - krb5
    - libssh2
    - openssl        # [unix]
    - libnghttp2     # [unix]
    - zlib

outputs:
  - name: libcurl
    script: install.sh  # [unix]
    script: install.bat  # [win]
    requirements:
      build:
        - {{ compiler('c') }}
        - make                # [unix]
        - libtool             # [unix]
      host:
        - openssl   # [unix]
        - libnghttp2   # [unix]
        - zlib
        - libssh2
        - krb5
      run:
        - libssh2
        - libnghttp2   # [unix]
    build:
      run_exports:
        - {{ pin_subpackage('libcurl') }}
    test:
      commands:
        - curl-config --features       # [not win]
        - curl-config --protocols      # [not win]
        - test -f ${PREFIX}/lib/libcurl${SHLIB_EXT}  # [not win]
        - test -f ${PREFIX}/include/curl/curl.h  # [not win]
        - test ! -f ${PREFIX}/lib/libcurl.a          # [not win]
        - if exist %LIBRARY_BIN%\curl.exe exit 1     # [win]
        - if exist %LIBRARY_LIB%\libcurl_a.lib exit 1     # [win]
        - if not exist %LIBRARY_BIN%\libcurl.dll exit 1   # [win]
        - if not exist %LIBRARY_LIB%\libcurl.exp exit 1   # [win]
        - if not exist %LIBRARY_LIB%\libcurl.lib exit 1   # [win]
        - if not exist %LIBRARY_PREFIX%\include\curl\curl.h exit 1   # [win]

  - name: libcurl-static
    script: install.sh  # [unix]
    script: install.bat  # [win]
    requirements:
      build:
        - {{ compiler('c') }}
        - make                # [unix]
        - libtool             # [unix]
      host:
        - openssl   # [unix]
        - zlib
        - libssh2
        - krb5
        - {{ pin_subpackage('libcurl', exact=True) }}
      run:
        - {{ pin_subpackage('libcurl', exact=True) }}
    files:
      - lib/libcurl.a*  # [unix]
      - Library/lib/libcurl_a.lib  # [win]
    test:
      commands:
        - test -f $PREFIX/lib/libcurl.a  # [not win]
        - if not exist %LIBRARY_LIB%\libcurl_a.lib exit 1  # [win]

  - name: libcurl-securetransport-static
    build:
      skip: true  # [not osx]
    script: build.sh  # [unix]
    requirements:
      build:
        - libtool     # [unix]
        - {{ compiler('c') }}
        - make        # [unix]
        # perl is required to run the tests on UNIX.
        - perl        # [unix]
        - pkg-config  # [unix]
      host:
        - libnghttp2  # [unix]
        - libssh2
        - zlib
        - krb5
      run:
        - libnghttp2   # [unix]

    test:
      commands:
        - test -f $PREFIX/lib/libcurl.a  # [not win]

  - name: curl
    script: install.sh  # [unix]
    script: install.bat  # [win]
    requirements:
      build:
        - {{ compiler('c') }}
        - make                # [unix]
        - libtool             # [unix]
      host:
        - {{ pin_subpackage('libcurl', exact=True) }}
        # OpenSSL is needed here to prevent conda-build from getting confused while
        # both OpenSSL 1.1.1 and 3.0.0 and being supported
        - openssl   # [unix]
        - zlib
        - libssh2
        - krb5
      run:
        - {{ pin_subpackage('libcurl', exact=True) }}
        - libssh2
    test:
      commands:
        # curl help commands on Windows have non-zero status codes.  Need other test.
        - curl --help
        # Try downloading something from https to make sure the certs are used correctly.
        - curl https://raw.githubusercontent.com/conda-forge/curl-feedstock/master/LICENSE.txt
        - if not exist %LIBRARY_BIN%\curl.exe exit 1  # [win]
        - if exist %LIBRARY_LIB%\libcurl_a.lib exit 1  # [win]

about:
  home: http://curl.haxx.se/
  license: curl
  license_family: MIT
  license_file: COPYING
  summary: tool and library for transferring data with URL syntax

  description: |
    Curl is an open source command line tool and library for transferring data
    with URL syntax. It is used in command lines or scripts to transfer data.
  doc_url: https://curl.haxx.se/docs/
  dev_url: https://github.com/curl/curl
  doc_source_url: https://github.com/curl/curl/tree/master/docs

extra:
  recipe-maintainers:
    - msarahan
    - jakirkham
    - ocefpaf
    - mingwandroid
    - xylar
